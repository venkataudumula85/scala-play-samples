/* uses sbt, which i installed with homebrew. */
/* this works without requiring the 'sbt plugin'. */

pipeline {
    agent any
    environment {
        SHORT_COMMIT = "${GIT_COMMIT[0..7]}"   
        VERSION="1.0.$SHORT_COMMIT"
      
    }
    stages {
       
        stage('Compile') {
            steps {
                dir('play-scala-forms-example'){
                echo "Compiling..."
                sh "APP_SECRET_KEY=`sbt playGenerateSecret` && sed -i 's/APP_SECRET_KEY/${APP_SECRET_KEY}/g' conf/application.conf"
                sh"cat conf/application.json"
                sh "sbt sbtVersion"
                }
            }
        }
 stage('Test') {
            steps {
                echo "Testing..."
                sh "cd play-scala-forms-example &&  sbt test"
            }
        }
        
        stage('Package') {
            steps {
                
                echo "Packaging..."
                sh "cd play-scala-forms-example && sbt rpm:packageBin"
            }
        }
         stage('Artifacts Upload') {
            steps {
        nexusArtifactUploader artifacts: [[artifactId: 'rpm-snapshot', classifier: '', file: 'play-scala-forms-example/target/rpm/RPMS/noarch/play-scala-forms-example-2.8.x-1.noarch.rpm', type: 'rpm']], credentialsId: 'nexus-password', groupId: 'scala', nexusUrl: '172.31.47.241:8081', nexusVersion: 'nexus3', protocol: 'http', repository: 'rpm-snapshot', version: '1.0.0'
       }
        }
        stage('Docker Build') {
            steps {
               sh "cd play-scala-forms-example && docker build -t 172.31.47.241:8083/play-scala-forms-example:$VERSION ."
            }
        }
         stage('Docker Upload') {
            steps {
        withDockerRegistry(credentialsId: 'nexus-password', url: 'http://172.31.47.241:8083') {
            sh "docker push 172.31.47.241:8083/play-scala-forms-example:$VERSION"
}
            }
         }
            }
             
}
